pipeline {
    agent any
    
    tools {
        maven 'M3'
        jdk 'JDK17'
    }
    
    environment {
        TOMCAT_HOME = '/opt/tomcat'
    }
    
    stages {
        // STAGE 1: Checkout GitHub
        stage('Checkout GitHub') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/Azza-Chaieb/devops-app.git'
                sh 'echo "‚úÖ Code source r√©cup√©r√© depuis GitHub"'
            }
        }
        
        // STAGE 2: Build Maven
        stage('Build') {
            steps {
                sh 'mvn clean compile'
                sh 'mvn package -DskipTests'
            }
            post {
                success {
                    echo '‚úÖ Build Maven r√©ussi!'
                    archiveArtifacts artifacts: 'target/*.war', fingerprint: true
                }
            }
        }
        
        // STAGE 3: Tests Unitaires
        stage('Tests Unitaires') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
        
        // STAGE 4: SAST - SonarQube
        stage('SAST - SonarQube') {
            steps {
                sh '''
                    # Analyse SonarQube
                    mvn sonar:sonar \
                    -Dsonar.projectKey=devops-app \
                    -Dsonar.projectName="DevOps Application" \
                    -Dsonar.host.url=http://localhost:9000 \
                    -Dsonar.login=admin \
                    -Dsonar.password=admin
                '''
            }
        }
        
        // STAGE 5: D√©ploiement Tomcat
        stage('D√©ploiement Tomcat') {
            steps {
                script {
                    sh """
                        # Arr√™ter Tomcat
                        echo "üõë Arr√™t de Tomcat..."
                        ${TOMCAT_HOME}/bin/shutdown.sh || true
                        sleep 5
                        
                        # Nettoyer l'ancienne d√©ploiement
                        echo "üßπ Nettoyage de l'ancienne version..."
                        rm -rf ${TOMCAT_HOME}/webapps/devops-app*
                        rm -rf ${TOMCAT_HOME}/webapps/ROOT*
                        
                        # D√©ployer la nouvelle version
                        echo "üöÄ D√©ploiement de la nouvelle version..."
                        cp target/devops-app.war ${TOMCAT_HOME}/webapps/ROOT.war
                        
                        # Red√©marrer Tomcat
                        echo "üîÅ Red√©marrage de Tomcat..."
                        ${TOMCAT_HOME}/bin/startup.sh
                        sleep 10
                        
                        echo "‚úÖ D√©ploiement termin√©!"
                    """
                }
            }
        }
        
        // STAGE 6: Test de l'application
        stage('Test Application') {
            steps {
                sh '''
                    echo "üîç Test de l'application d√©ploy√©e..."
                    echo "URL: http://localhost:8082/"
                    curl -s http://localhost:8082/ | head -5 || echo "‚ö†Ô∏è Application en cours de d√©marrage..."
                '''
            }
        }
    }
    
    post {
        always {
            echo "üèÅ Pipeline ${currentBuild.result}"
        }
        success {
            echo 'üéâ Pipeline CI/CD ex√©cut√©e avec succ√®s avec 6 stages!'
        }
    }
}